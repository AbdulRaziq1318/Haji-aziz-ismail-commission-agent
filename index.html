<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Haji Abdul Aziz Ismail - Bill Generator</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Icons & html2canvas -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root{
            --primary: #1A237E;
            --secondary: #424242;
            --accent-green: #2E7D32;
            --soft-bg: #F7F9FC;
            --border-soft: #E0E0E0;

            /* Notes box tuning */
            --note-line-color: #000;     /* line color (change #444 if too strong) */
            --note-font-size: 16px;      /* font-size used inside preview note */
            --note-line-height: 28px;    /* distance between visual lines */
            --note-heading-height: 36px; /* reserved heading area inside box (تفصیل) */
            --note-line-offset: 6px;     /* small offset to position lines slightly below baseline */
        }

        html,body{height:100%}
        body{
            margin:0;
            font-family: "Open Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background: var(--soft-bg);
            color: var(--secondary);
            -webkit-print-color-adjust:exact;
            print-color-adjust:exact;
        }

        .font-eng { font-family: 'Montserrat', sans-serif; }
        .font-body { font-family: 'Open Sans', sans-serif; }
        .font-urdu { font-family: 'Noto Naskh Arabic', serif; }

        .invoice-card { background:#fff; border:1px solid var(--border-soft); border-radius:12px; box-shadow:0 8px 28px rgba(14,22,44,0.06); overflow:hidden; }

        .input-underline { border:none; border-bottom:2px solid #e6e7eb; padding:6px 0; background:transparent; transition:border-color .15s; }
        .input-underline:focus{ outline:none; border-bottom-color:var(--primary); }

        /* Header fruit images */
        .header-fruit { position:absolute; top:50%; transform:translateY(-50%); width:95px; height:auto; opacity:.95; }
        .header-fruit.left{ left:12px; }
        .header-fruit.right{ right:12px; }

        .header-center { padding-left:7rem; padding-right:7rem; }

        @media (max-width: 900px) {
            .header-center { padding-left:2rem; padding-right:2rem; }
            .header-fruit { width:72px; }
        }

        /* MAIN PREVIEW GRID: left 50% / right 50% */
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 50/50 */
            gap: 1rem;
            align-items: start;
        }

        .left-col, .right-col {
            min-height: 220px;
        }
        .left-col { display:flex; flex-direction:column; gap:1rem; }
        .right-col { display:flex; flex-direction:column; gap:1rem; }

        /* boxes */
        .box-break { background:var(--soft-green); border:1px solid var(--accent-green); border-radius:12px; padding:18px; }

        /* ===== Notes box: improved alignment =====
           Approach:
           - Lines are rendered by an absolutely positioned layer (.note-lines).
           - .note-lines top is set so lines begin below the heading area.
           - .note-content uses the same line-height as the lines, and a small padding-top
             so that typed text's baseline sits above the visual rule (line).
        */
        .box-notes {
            background:#fff;
            border:1px solid #e6e6e6;
            border-radius:12px;
            padding:8px 12px 14px 12px;
            box-shadow:0 6px 12px rgba(0,0,0,0.04);
            min-height: calc(var(--note-heading-height) + var(--note-line-height) * 3);
            position:relative;
            overflow:visible;
        }

        /* the ruled lines layer (absolute), starts below heading area */
        .box-notes .note-lines {
            position:absolute;
            left:0;
            right:0;
            /* start lines a bit lower than heading;
               using line-height and a small offset so lines fall under text baseline */
            top: calc(var(--note-heading-height) + var(--note-line-height) - var(--note-line-offset));
            bottom:8px;
            z-index:0;
            background-image: linear-gradient(to bottom, var(--note-line-color) 1px, transparent 1px);
            background-size: 100% var(--note-line-height);
            pointer-events:none;
        }

        .box-notes .note-heading {
            position:relative;
            z-index:2;
            font-weight:700;
            color:var(--primary);
            margin:0 0 6px 0;
            height: var(--note-heading-height);
            line-height: var(--note-heading-height);
        }

        .box-notes .note-content {
            position:relative;
            z-index:2;
            /* IMPORTANT: text line-height matches visual line spacing */
            font-size: var(--note-font-size);
            line-height: var(--note-line-height);
            min-height: calc(var(--note-line-height) * 3);
            color:#000;
            white-space: pre-wrap;
            /* small top padding to vertically align text baseline above the visual line */
            padding-top: calc(var(--note-line-offset) - 2px);
            padding-left: 6px;
            padding-right: 6px;
        }

        .box-comm { background:#fff; border:1px solid rgba(0,0,0,0.06); border-left:6px solid var(--accent-green); border-radius:10px; padding:14px; }

        .break-row { display:flex; justify-content:space-between; padding:8px 0; align-items:center; }
        .break-title { color:var(--accent-green); font-weight:700; }
        .break-val { color:var(--secondary); font-weight:700; }
        .break-highlight { color:var(--accent-green); font-weight:800; font-size:1.05rem; }
        .break-total { color:#D04545; font-weight:800; font-size:1.1rem; }

        .items-preview-table { display:none !important; }

        /* small control buttons area */
        .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

        /* print fixes */
        @media print {
            @page { margin: 0; size: auto; }
            .no-print, .no-print * { display:none !important; visibility:hidden !important; }
            body{ margin:0 !important; padding:0 !important; }
            .invoice-card{ box-shadow:none !important; border:none !important; }
            .header-fruit { display:block !important; opacity:1 !important; width:95px !important; }
            img { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            /* ensure ruled lines print as well and start at same place */
            .box-notes .note-lines {
                background-image: linear-gradient(to bottom, var(--note-line-color) 1px, transparent 1px);
            }
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-6xl mx-auto p-6 md:p-10">

    <!-- Top controls -->
    <div class="flex items-center justify-between mb-6 no-print">
        <h1 class="text-2xl font-eng font-semibold text-[var(--primary)]">Haji Ismail Commission Agent</h1>

        <div class="controls">
            <button onclick="updateBill()" class="bg-[var(--accent-green)] text-white px-4 py-2 rounded-md">Apply Preview</button>
            <button onclick="printBill()" class="bg-[var(--primary)] text-white px-4 py-2 rounded-md">Print Bill</button>
            <button onclick="downloadImage()" class="bg-gray-700 text-white px-4 py-2 rounded-md">Download Image</button>
            <button onclick="shareWhatsApp()" class="bg-green-600 text-white px-4 py-2 rounded-md">Share (WhatsApp)</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- LEFT: form -->
        <div class="space-y-6 no-print">

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">Bill Details</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">Customer Name</label>
                        <input id="customerName" type="text" class="w-full input-underline font-body" placeholder="Enter name">
                    </div>
                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">Date</label>
                        <input id="date" type="date" class="w-full input-underline font-body">
                    </div>
                </div>
            </div>

            <div class="invoice-card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-eng font-semibold text-[var(--primary)]">Items</h2>
                    <button onclick="addItem()" class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100">+ Add Item</button>
                </div>
                <div id="itemsList" class="space-y-4"></div>
            </div>

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">Expenses (Per-unit)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="text-sm font-body text-[var(--secondary)]">کمیشن (%):</label>
                        <div class="flex gap-4 items-center">
                            <input id="commissionPercent" type="number" class="input-underline font-body w-full" placeholder="مثلاً 2.5" min="0" step="any">
                            <span class="text-sm text-gray-500">%</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">مزدوری فی یونٹ</label>
                        <input id="laborPerItem" type="number" class="w-full input-underline font-body" placeholder="مثلاً 80" value="0" min="0" step="any">
                    </div>

                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">کرایہ فی یونٹ</label>
                        <input id="freightPerItem" type="number" class="w-full input-underline font-body" placeholder="مثلاً 50" value="0" min="0" step="any">
                    </div>
                </div>
            </div>

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">نوٹس</h2>
                <textarea id="notes" rows="3" class="w-full input-underline font-body" placeholder="کوئی تفصیل..."></textarea>
            </div>
        </div>

        <!-- RIGHT: preview -->
        <div class="lg:sticky lg:top-8 h-fit">

            <div id="billPreview" class="invoice-card p-6 overflow-hidden">

                <!-- header -->
                <div class="relative pb-4 border-b-2 border-[var(--primary)]">
                    <img src="fruits.png" alt="fruits" class="header-fruit left">
                    <img src="fruits.png" alt="fruits" class="header-fruit right">
                    <div class="text-center header-center">
                        <h1 class="text-[34px] font-urdu font-bold text-[var(--primary)] leading-tight">حاجی عبدالعزیز اسماعیل</h1>
                        <h2 class="mt-2 text-lg font-eng font-semibold text-[var(--accent-green)]">HAJI ABDUL AZIZ ISMAIL</h2>
                        <p class="text-sm font-body text-[var(--secondary)] mt-1">Fruits & Vegetable Commission Agent</p>
                        <p class="font-body text-[var(--secondary)] text-sm mt-1">Contact: 0333-9973274 | 0348-9056525</p>
                        <p class="font-urdu text-[var(--primary)] font-semibold mt-1 text-sm">شاپ نمبر 104 نیو سبزی منڈی رتہ کلاچی ڈیرہ اسماعیل خان</p>
                    </div>
                </div>

                <!-- customer row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 font-urdu" dir="rtl">
                    <div class="flex items-center justify-between border-b border-[var(--border-soft)] pb-2">
                        <span class="font-bold text-[var(--primary)]">محترم جناب:</span>
                        <span id="previewName" class="font-body text-lg text-[var(--secondary)]"></span>
                    </div>
                    <div class="flex items-center justify-between border-b border-[var(--border-soft)] pb-2" dir="ltr">
                        <span class="font-urdu font-bold text-[var(--primary)]">تاریخ:</span>
                        <span id="previewDate" class="font-body text-lg text-[var(--secondary)]"></span>
                    </div>
                </div>

                <!-- preview grid 50/50 -->
                <div class="preview-grid mt-8">

                    <!-- LEFT 50% -->
                    <div class="left-col">
                        <div class="box-break">
                            <div class="break-row"><div class="break-title">کچی بِکری</div><div id="previewKachiBikri" class="break-val">-</div></div>
                            <div class="break-row"><div class="break-title">خرچہ</div><div id="previewKharcha" class="break-val">-</div></div>
                            <div style="border-top:1px dashed rgba(0,0,0,0.06);margin:8px 0;"></div>
                            <div class="break-row"><div class="break-title">پکی بِکری</div><div id="previewPakiBikri" class="break-highlight">-</div></div>
                            <div style="height:14px"></div>
                            <div class="break-row"><div class="break-title">کل</div><div id="previewGrand" class="break-total">-</div></div>
                        </div>
                    </div>

                    <!-- RIGHT 50% -->
                    <div class="right-col">

                        <!-- notes top -->
                        <div class="box-notes">
                            <div class="note-heading">تفصیل</div>

                            <!-- absolute lines layer -->
                            <div class="note-lines" aria-hidden="true"></div>

                            <!-- content (text shown here) -->
                            <div id="previewNotesShort" class="note-content">(کوئی تفصیل نہیں)</div>
                        </div>

                        <!-- summary below notes -->
                        <div class="box-comm">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                <div style="font-weight:700;color:var(--primary);">خلاصہ</div>
                                <div style="font-size:0.85rem;color:#6b7280;"></div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>کمیشن</div>
                                <div id="previewCommission" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>مزدوری</div>
                                <div id="previewLabor" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>کرایہ</div>
                                <div id="previewFreight" class="font-bold">-</div>
                            </div>

                            <div style="border-top:1px solid rgba(0,0,0,0.06);margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;">
                                <div style="font-weight:800;color:#333;">ٹوٹل</div>
                                <div id="previewTotalExp" class="font-bold break-total">-</div>
                            </div>

                            <div style="margin-top:10px;text-align:center;">
                                <div style="font-size:0.95rem;font-weight:700;color:var(--accent-green);" id="previewNetLabel">خالص</div>
                                <div style="font-size:1.35rem;font-weight:800;color:var(--accent-green);" id="previewPakiNet">-</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- hidden items preview (kept DOM) -->
                <div class="mt-8 items-preview-table">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-[var(--secondary)]">
                                    <th class="pb-2">Qty</th>
                                    <th class="pb-2">Unit</th>
                                    <th class="pb-2">Description</th>
                                    <th class="pb-2">Rate</th>
                                    <th class="pb-2">Line Total</th>
                                </tr>
                            </thead>
                            <tbody id="itemsPreviewBody" class="text-gray-700"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
    if (window.lucide) lucide.createIcons();

    // format helper
    function fmt(num) {
        if (num === null || num === undefined || isNaN(num)) return "-";
        return Math.round(num).toLocaleString();
    }

    document.addEventListener("DOMContentLoaded", function() {
        const dateInput = document.getElementById("date");
        if (dateInput) dateInput.valueAsDate = new Date();
        addItem();
        updateBill();
    });

    // add item
    function addItem() {
        const container = document.getElementById("itemsList");
        const id = "item-" + Date.now();
        const div = document.createElement("div");
        div.id = id;
        div.className = "grid grid-cols-[1fr_1fr_2fr_1fr_auto] gap-4 items-end pb-4 border-b last:border-0";
        div.innerHTML = `
            <div>
                <label class="text-xs font-body text-gray-600">Qty</label>
                <input type="number" class="item-qty w-full input-underline font-body" placeholder="1" value="1" min="0" step="any">
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Unit</label>
                <select class="item-unit w-full input-underline font-body bg-white">
                    <option value="Peti">Peti</option><option value="Bori">Bori</option><option value="Nag">Nag</option><option value="Dozen">Dozen</option><option value="Kg">Kg</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Description</label>
                <input type="text" class="item-desc w-full input-underline font-body" placeholder="Item name">
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Rate</label>
                <input type="number" class="item-rate w-full input-underline font-body" placeholder="0" value="0" min="0" step="any">
            </div>
            <div class="flex items-center gap-2">
                <button type="button" onclick="removeItem('${id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-md">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
        if (window.lucide) lucide.createIcons();
        const inputs = div.querySelectorAll("input, select");
        inputs.forEach(inp => inp.addEventListener("input", debounceUpdate));
        updateBill();
    }

    function removeItem(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const all = document.querySelectorAll("#itemsList > div");
        if (all.length <= 1) {
            const qty = el.querySelector(".item-qty");
            const desc = el.querySelector(".item-desc");
            const rate = el.querySelector(".item-rate");
            const unit = el.querySelector(".item-unit");
            if (qty) qty.value = 0;
            if (desc) desc.value = "";
            if (rate) rate.value = 0;
            if (unit) unit.selectedIndex = 0;
        } else {
            el.remove();
        }
        updateBill();
    }

    let updateTimer = null;
    function debounceUpdate() {
        if (updateTimer) clearTimeout(updateTimer);
        updateTimer = setTimeout(() => { updateBill(); updateTimer = null; }, 150);
    }

    function printBill() {
        updateBill();
        setTimeout(() => window.print(), 200);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"'`=\/]/g, function (s) {
            return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[s];
        });
    }

    function updateBill() {
        const name = document.getElementById("customerName").value || "";
        const dateVal = document.getElementById("date").value || "";

        const rows = document.querySelectorAll("#itemsList > div");
        let subtotal = 0;
        let totalQty = 0;
        const previewRows = [];

        rows.forEach(row => {
            const qEl = row.querySelector(".item-qty");
            const rEl = row.querySelector(".item-rate");
            const uEl = row.querySelector(".item-unit");
            const dEl = row.querySelector(".item-desc");
            const qty = parseFloat(qEl?.value) || 0;
            const rate = parseFloat(rEl?.value) || 0;
            const unit = uEl?.value || "";
            const desc = dEl?.value || "";
            const lineTotal = qty * rate;
            subtotal += lineTotal;
            totalQty += qty;
            previewRows.push({ qty, unit, desc, rate, lineTotal });
        });

        const commissionPercent = parseFloat(document.getElementById("commissionPercent").value) || 0;
        const commission = Math.round(subtotal * (commissionPercent / 100));

        const freightPerItem = parseFloat(document.getElementById("freightPerItem").value) || 0;
        const laborPerItem = parseFloat(document.getElementById("laborPerItem").value) || 0;
        const freightTotal = freightPerItem * totalQty;
        const laborTotal = laborPerItem * totalQty;

        const totalExpenses = commission + freightTotal + laborTotal;
        const netTotal = subtotal - totalExpenses;

        // header
        document.getElementById("previewName").textContent = name;
        if (dateVal) {
            const d = new Date(dateVal);
            document.getElementById("previewDate").textContent = d.toLocaleDateString("en-GB");
        } else {
            document.getElementById("previewDate").textContent = "";
        }

        // left breakdown
        document.getElementById("previewKachiBikri").textContent = subtotal > 0 ? fmt(subtotal) : "-";
        document.getElementById("previewKharcha").textContent = totalExpenses > 0 ? fmt(totalExpenses) : "-";
        document.getElementById("previewPakiBikri").textContent = netTotal > 0 ? fmt(netTotal) : "-";
        document.getElementById("previewGrand").textContent = subtotal > 0 ? fmt(subtotal) : "-";

        // right totals (urdu)
        document.getElementById("previewCommission").textContent = commission > 0 ? fmt(commission) : "-";
        document.getElementById("previewFreight").textContent = freightTotal > 0 ? fmt(freightTotal) : "-";
        document.getElementById("previewLabor").textContent = laborTotal > 0 ? fmt(laborTotal) : "-";
        document.getElementById("previewTotalExp").textContent = totalExpenses > 0 ? fmt(totalExpenses) : "-";
        document.getElementById("previewPakiNet").textContent = netTotal > 0 ? fmt(netTotal) : "-";

        // notes
        const notes = document.getElementById("notes").value || "";
        const notesShort = document.getElementById("previewNotesShort");
        if (notes.trim()) {
            notesShort.textContent = notes;
        } else {
            notesShort.textContent = "(کوئی تفصیل نہیں)";
        }

        // populate hidden items table (kept DOM)
        const tbody = document.getElementById("itemsPreviewBody");
        if (tbody) {
            tbody.innerHTML = "";
            previewRows.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td class="py-2">${r.qty}</td><td class="py-2">${escapeHtml(r.unit)}</td><td class="py-2">${escapeHtml(r.desc)}</td><td class="py-2">${r.rate?fmt(r.rate):"-"}</td><td class="py-2 font-bold">${r.lineTotal?fmt(r.lineTotal):"-"}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    /* ---------- Image export & WhatsApp share ---------- */

    async function downloadImage() {
        updateBill();
        const el = document.getElementById('billPreview');
        const prevShadow = el.style.boxShadow;
        el.style.boxShadow = 'none';

        const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
        const dataUrl = canvas.toDataURL('image/png');

        el.style.boxShadow = prevShadow;

        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `bill-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    async function shareWhatsApp() {
        updateBill();
        const el = document.getElementById('billPreview');
        const prevShadow = el.style.boxShadow;
        el.style.boxShadow = 'none';

        try {
            const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1));
            el.style.boxShadow = prevShadow;

            const file = new File([blob], `bill-${Date.now()}.png`, { type: 'image/png' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'بل',
                        text: 'بل برائے حاجی عبدالعزیز اسماعیل'
                    });
                    return;
                } catch (err) {
                    console.warn('navigator.share failed:', err);
                }
            }

            // Fallback: download then open WhatsApp web with a message
            const download = document.createElement('a');
            const url = URL.createObjectURL(blob);
            download.href = url;
            download.download = `bill-${Date.now()}.png`;
            document.body.appendChild(download);
            download.click();
            download.remove();

            const msg = encodeURIComponent('میں نے بل ڈاؤنلوڈ کر لیا ہے — براہِ مہربانی اس تصویر کو واٹس ایپ میں منسلک کریں۔');
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        } catch (err) {
            console.error('Share error:', err);
            const msg = encodeURIComponent('Invoice generated. Please share manually.');
            window.open(`https://wa.me/?text=${msg}`, '_blank');
            el.style.boxShadow = prevShadow;
        }
    }
</script>

</body>
</html>
