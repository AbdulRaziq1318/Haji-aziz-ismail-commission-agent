<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Haji Abdul Aziz Ismail - Bill Generator (Restored)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Icons & html2canvas -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root{
            --primary: #1A237E;
            --secondary: #424242;
            --accent-green: #2E7D32;
            --soft-bg: #F7F9FC;
            --border-soft: #E0E0E0;
            --header-orange: #FFF3E0; /* light orange */
            --left-border: var(--accent-green);
            --right-border: #D32F2F; /* red */
            --header-border-width: 3px;
            --header-radius: 10px;

            --note-line-color: #000;
            --note-font-size: 16px;
            --note-line-height: 28px;
            --note-heading-height: 36px;
            --note-line-offset: 6px;
        }

        html,body{height:100%}
        body{
            margin:0;
            font-family: "Open Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background: var(--soft-bg);
            color: var(--secondary);
            -webkit-print-color-adjust:exact;
            print-color-adjust:exact;
        }

        .font-eng { font-family: 'Montserrat', sans-serif; }
        .font-body { font-family: 'Open Sans', sans-serif; }
        .font-urdu { font-family: 'Noto Naskh Arabic', serif; }

        /* direction utility classes */
        .rtl { direction: rtl !important; text-align: right !important; }
        .ltr { direction: ltr !important; text-align: left !important; }

        .invoice-card { background:#fff; border:1px solid var(--border-soft); border-radius:12px; box-shadow:0 8px 28px rgba(14,22,44,0.06); overflow:hidden; }

        .input-underline { border:none; border-bottom:2px solid #e6e7eb; padding:6px 0; background:transparent; transition:border-color .15s; }
        .input-underline:focus{ outline:none; border-bottom-color:var(--primary); }

        .header-fruit { position:absolute; top:50%; transform:translateY(-50%); width:95px; height:auto; opacity:.95; }
        .header-fruit.left{ left:12px; }
        .header-fruit.right{ right:12px; }

        .header-center { padding-left:7rem; padding-right:7rem; }

        @media (max-width: 900px) {
            .header-center { padding-left:2rem; padding-right:2rem; }
            .header-fruit { width:72px; }
        }

        /* preview grid: keep two columns but swap DOM order to change visual positions */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; }
        .left-col, .right-col { min-height: 220px; }
        .left-col { display:flex; flex-direction:column; gap:1rem; }
        .right-col { display:flex; flex-direction:column; gap:1rem; }

        /* summary style used for summary + styled kachi/paki */
        .box-comm { background:#E8F5E9; border:1px solid rgba(0,0,0,0.06); border-left:6px solid var(--accent-green); border-radius:10px; padding:14px; box-shadow:0 6px 12px rgba(0,0,0,0.04); font-weight:600; }

        .box-notes { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:8px 12px 14px 12px; min-height: calc(var(--note-line-height) * 6); position:relative; overflow:visible; }
        .box-notes .note-lines { position:absolute; left:0; right:0; top: calc(var(--note-heading-height) + var(--note-line-height) - var(--note-line-offset)); bottom:8px; z-index:0; background-image: linear-gradient(to bottom, var(--note-line-color) 1px, transparent 1px); background-size: 100% var(--note-line-height); pointer-events:none; }
        .box-notes .note-heading { position:relative; z-index:2; font-weight:700; color:var(--primary); margin:0 0 6px 0; height: var(--note-heading-height); line-height: var(--note-heading-height); }
        .box-notes .note-content { position:relative; z-index:2; font-size: var(--note-font-size); line-height: var(--note-line-height); min-height: calc(var(--note-line-height) * 5); color:#000; white-space: pre-wrap; padding-top: calc(var(--note-line-offset) - 2px); padding-left: 6px; padding-right: 6px; }

        .break-row { display:flex; justify-content:space-between; padding:8px 0; align-items:center; }
        .break-title { color:var(--accent-green); font-weight:700; }
        .break-val { color:var(--secondary); font-weight:700; }
        .break-highlight { color:var(--accent-green); font-weight:800; font-size:1.05rem; }
        .break-total { color:#D04545; font-weight:800; font-size:1.1rem; }

        .items-preview-table { display:none !important; }

        .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

        /* gradient text utility (left in CSS but not used) */
        .gradient-text {
            background: linear-gradient(90deg,#0D47A1,#D32F2F,#2E7D32);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Header box with split border (left green, right red) */
        .header-box {
            position: relative;
            border-radius: var(--header-radius);
            /* ensure printing keeps background/color */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        /* left half border */
        .header-box::before,
        .header-box::after {
            content: "";
            position: absolute;
            top: 0;
            height: 100%;
            width: 50%;
            pointer-events: none;
            box-sizing: border-box;
            border-radius: var(--header-radius);
            z-index: 3; /* border sits above content edges */
        }
        .header-box::before {
            left: 0;
            border-top: var(--header-border-width) solid var(--left-border);
            border-left: var(--header-border-width) solid var(--left-border);
            border-bottom: var(--header-border-width) solid var(--left-border);
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            background-clip: padding-box;
        }
        .header-box::after {
            right: 0;
            border-top: var(--header-border-width) solid var(--right-border);
            border-right: var(--header-border-width) solid var(--right-border);
            border-bottom: var(--header-border-width) solid var(--right-border);
            border-left: none;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            background-clip: padding-box;
        }

        /* ensure header content is above pseudo borders */
        .header-content {
            position: relative;
            z-index: 4;
        }

        @media print {
            /* Hide any element explicitly marked no-print */
            .no-print { display: none !important; }

            /* Strong "print only the bill preview" strategy:
               hide everything visually, then make the billPreview visible.
               This reliably ensures only the bill content is included in PDF. */
            body * { visibility: hidden !important; }
            #billPreview, #billPreview * { visibility: visible !important; }

            /* Place the billPreview at top-left and full width for printing */
            #billPreview {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                box-shadow: none !important;
                margin: 0 !important;
                border: none !important;
            }

            /* Ensure header pseudo borders print correctly */
            .header-box::before, .header-box::after { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

            /* Page setup tweaks */
            @page { margin: 12mm; }
            html, body { height: auto !important; }
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-6xl mx-auto p-6 md:p-10">

    <!-- Top controls -->
    <div class="flex items-center justify-between mb-6 no-print">
        <h1 class="text-2xl font-eng font-semibold text-[var(--primary)]">Haji Ismail Commission Agent</h1>

        <div class="controls">
            <button onclick="updateBill()" class="bg-[var(--accent-green)] text-white px-4 py-2 rounded-md">Apply Preview</button>
            <button onclick="printBill()" class="bg-[var(--primary)] text-white px-4 py-2 rounded-md">Print Bill</button>
            <button onclick="downloadImage()" class="bg-gray-700 text-white px-4 py-2 rounded-md">Download Image</button>
            <button onclick="shareWhatsApp()" class="bg-green-600 text-white px-4 py-2 rounded-md">Share (WhatsApp)</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- LEFT: form -->
        <div class="space-y-6 no-print">

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">Bill Details</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">Customer Name</label>
                        <input id="customerName" type="text" class="w-full input-underline font-body" placeholder="Enter name">
                    </div>
                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">Date</label>
                        <input id="date" type="date" class="w-full input-underline font-body">
                    </div>
                </div>
            </div>

            <div class="invoice-card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-eng font-semibold text-[var(--primary)]">Items</h2>
                    <button onclick="addItem()" class="px-3 py-2 text-sm border rounded-md hover:bg-gray-100">+ Add Item</button>
                </div>
                <div id="itemsList" class="space-y-4"></div>
            </div>

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">Expenses (Per-unit)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="text-sm font-body text-[var(--secondary)]">کمیشن (%):</label>
                        <div class="flex gap-4 items-center">
                            <input id="commissionPercent" type="number" class="input-underline font-body w-full" placeholder="مثلاً 2.5" min="0" step="any">
                            <span class="text-sm text-gray-500">%</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">مزدوری فی یونٹ</label>
                        <input id="laborPerItem" type="number" class="w-full input-underline font-body" placeholder="مثلاً 80" value="0" min="0" step="any">
                    </div>

                    <div>
                        <label class="text-sm font-body text-[var(--secondary)]">کرایہ فی یونٹ</label>
                        <input id="freightPerItem" type="number" class="w-full input-underline font-body" placeholder="مثلاً 50" value="0" min="0" step="any">
                    </div>

                    <!-- Munshiyana fixed amount (NOT per-unit) -->
                    <div class="md:col-span-2">
                        <label class="text-sm font-body text-[var(--secondary)]">منشیانہ (کل فکس رقم)</label>
                        <input id="munshiyanaFixed" type="number" class="w-full input-underline font-body" placeholder="مثلاً 200" value="0" min="0" step="any">
                    </div>
                </div>
            </div>

            <div class="invoice-card p-6">
                <h2 class="text-lg font-eng font-semibold text-[var(--primary)] mb-4">نوٹس</h2>
                <!-- textarea now will get rtl/ltr classes dynamically -->
                <textarea id="notes" rows="3" class="w-full input-underline font-body ltr" placeholder="کوئی تفصیل..."></textarea>
            </div>
        </div>

        <!-- RIGHT: preview -->
        <div class="lg:sticky lg:top-8 h-fit">

            <div id="billPreview" class="invoice-card p-6 overflow-hidden">

                <!-- header with soft background (LIGHT ORANGE) and split border -->
   <div class="relative pb-4 header-box" style="background: var(--header-orange); padding:1.25rem; border-radius:var(--header-radius); -webkit-print-color-adjust:exact; print-color-adjust:exact;">

    <!-- Premium Gradient Badge (Right Side, Soft Glow, Correct Position) -->
    <div style="
        position:absolute;
        top:-15px;
        right:-05px;
        z-index:80;

        width:68px;
        height:68px;
        border-radius:50%;
        background:white;

        /* GRADIENT BLUE → GOLD BORDER */
        padding:4px;
        background: linear-gradient(135deg, #0D47A1, #FFD54F);

        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 6px 20px rgba(0,0,0,0.18);
    ">
        <div style="
            background:white;
            width:100%;
            height:100%;
            border-radius:50%;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding-top:6px;
        ">
            <div style="font-size:7px; font-weight:800; color:#0D47A1; white-space:nowrap;">
                TRADE MARK
            </div>

            <div style="
                font-size:24px;
                font-weight:900;
                color:#D32F2F;
                margin-top:-4px;

                /* SOFT GLOW BEHIND AI */
                text-shadow:0 0 6px rgba(255, 0, 0, 0.45);
            ">
                AI
            </div>
        </div>
    </div>

    <img src="fruits.png" alt="fruits" class="header-fruit left">
    <img src="fruits.png" alt="fruits" class="header-fruit right">

   <div class="text-center header-center header-content">
    <h1 class="text-[34px] font-urdu font-bold leading-tight" style="margin:0; color:#D32F2F;">حاجی عبدالعزیز اسماعیل</h1>
    <h2 class="mt-2 text-lg font-eng font-semibold" style="margin:0; color:#0D47A1;">HAJI ABDUL AZIZ ISMAIL</h2>

    <p class="text-sm font-body text-[var(--secondary)] mt-1">
        Fruits & Vegetable Commission Agent
    </p>

    <p class="font-body text-[var(--secondary)] text-sm mt-1">
        Contact:
        <a href="tel:03339973274" class="underline whitespace-nowrap">
            0333-9973274
        </a>
        |
        <a href="tel:03489056525" class="underline whitespace-nowrap">
            0348-9056525
        </a>
    </p>

    <p class="font-urdu text-[var(--primary)] font-semibold mt-1 text-sm">
        شاپ نمبر 104 نیو سبزی منڈی رتہ کلاچی ڈیرہ اسماعیل خان
    </p>
</div>


</div>

                <!-- CUSTOMER ROW -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 font-urdu mt-6 mb-2" dir="rtl">
                    <div class="flex items-center justify-between border-b border-[var(--border-soft)] pb-2" style="direction: ltr;">
                        <span class="font-urdu font-bold text-[var(--primary)]">تاریخ:</span>
                        <span id="previewDate" class="font-body text-lg text-[var(--secondary)]"></span>
                    </div>
                    <div class="flex items-center justify-between border-b border-[var(--border-soft)] pb-2" style="direction: rtl;">
                        <span class="font-bold text-[var(--primary)]">محترم جناب:</span>
                        <span id="previewName" class="font-body text-lg text-[var(--secondary)]"></span>
                    </div>
                </div>

                <!-- preview grid -->
                <div class="preview-grid mt-2">

                    <!-- LEFT column -->
                    <div class="left-col">

                        <!-- Kachi / Paki box -->
                        <div class="box-comm">
                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>کچی بِکری</div>
                                <div id="previewKachiBikri" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>خرچہ</div>
                                <div id="previewKharcha" class="font-bold">-</div>
                            </div>

                            <div style="border-top:1px dashed rgba(0,0,0,0.06);margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;">
                                <div style="font-weight:800;color:#333;">پکی بِکری</div>
                                <div id="previewPakiBikri" class="font-bold break-highlight">-</div>
                            </div>
                        </div>

                        <!-- SUMMARY -->
                        <div class="box-comm mt-3">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                <div style="font-weight:700;color:var(--primary);">خلاصہ</div>
                                <div style="font-size:0.85rem;color:#6b7280;"></div>
                            </div>

                            <!-- ORDER: Freight, Commission, Labor, Munshiyana (fixed), Total -->
                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>کرایہ</div>
                                <div id="previewFreight" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>کمیشن</div>
                                <div id="previewCommission" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>مزدوری</div>
                                <div id="previewLabor" class="font-bold">-</div>
                            </div>

                            <div style="display:flex;justify-content:space-between;padding:6px 0;">
                                <div>منشیانہ</div>
                                <div id="previewMunshiyana" class="font-bold">-</div>
                            </div>

                            <div style="border-top:1px solid rgba(0,0,0,0.06);margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;">
                                <div style="font-weight:800;color:#333;">ٹوٹل</div>
                                <div id="previewTotalExp" class="font-bold break-total">-</div>
                            </div>
                        </div>

                    </div>

                    <!-- RIGHT column -->
                    <div class="right-col">
                        <div class="box-notes" style="flex:1;">
                            <div class="note-heading">تفصیل</div>
                            <div class="note-lines" aria-hidden="true"></div>
                            <!-- previewNotesShort will get rtl/ltr and font classes dynamically -->
                            <div id="previewNotesShort" class="note-content ltr font-body" style="min-height:calc(var(--note-line-height) * 10);">(کوئی تفصیل نہیں)</div>
                        </div>
                    </div>

                </div>

                <div class="mt-8 items-preview-table">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-[var(--secondary)]">
                                    <th class="pb-2">Qty</th>
                                    <th class="pb-2">Unit</th>
                                    <th class="pb-2">Description</th>
                                    <th class="pb-2">Rate</th>
                                    <th class="pb-2">Line Total</th>
                                </tr>
                            </thead>
                            <tbody id="itemsPreviewBody" class="text-gray-700"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
    if (window.lucide) lucide.createIcons();

    /* ----------------- formatting helpers ----------------- */
    function formatNumberSmart(num) {
        if (num === null || num === undefined || isNaN(num)) return "-";
        const rounded = Math.round((num + Number.EPSILON) * 100) / 100;
        if (Number.isInteger(rounded)) {
            return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(rounded);
        } else {
            return new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(rounded);
        }
    }

    function formatCurrency(num) {
        if (num === null || num === undefined || isNaN(num)) return "-";
        return 'Rs ' + formatNumberSmart(Number(num));
    }

    // Regex to detect Arabic/Urdu script characters
    const arabicOrUrduRegex = /[\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]/;

    // Apply direction/font classes to notes textarea and preview based on text content
    function applyDirectionForNotes(text) {
        const notesEl = document.getElementById('notes');
        const previewEl = document.getElementById('previewNotesShort');
        const isRTL = arabicOrUrduRegex.test(text);

        // textarea classes
        if (isRTL) {
            notesEl.classList.add('rtl', 'font-urdu');
            notesEl.classList.remove('ltr', 'font-body');
        } else {
            notesEl.classList.add('ltr', 'font-body');
            notesEl.classList.remove('rtl', 'font-urdu');
        }

        // preview classes
        if (previewEl) {
            if (isRTL) {
                previewEl.classList.add('rtl', 'font-urdu');
                previewEl.classList.remove('ltr', 'font-body');
            } else {
                previewEl.classList.add('ltr', 'font-body');
                previewEl.classList.remove('rtl', 'font-urdu');
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        const dateInput = document.getElementById("date");
        if (dateInput) dateInput.valueAsDate = new Date();

        addItem();

        const watchIds = ["commissionPercent","laborPerItem","freightPerItem","munshiyanaFixed","customerName","notes","date"];
        watchIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener("input", debounceUpdate);
            }
        });

        // Ensure notes direction is set on load and update on input immediately
        const notesEl = document.getElementById('notes');
        if (notesEl) {
            applyDirectionForNotes(notesEl.value || "");
            notesEl.addEventListener('input', function(e) {
                applyDirectionForNotes(e.target.value || "");
                // we already debounce update via list above; call updateBill immediately to reflect direction+content faster
                debounceUpdate();
            });
        }

        updateBill();
    });

    function addItem() {
        const container = document.getElementById("itemsList");
        const id = "item-" + Date.now();
        const div = document.createElement("div");
        div.id = id;
        div.className = "grid grid-cols-[1fr_1fr_2fr_1fr_auto] gap-4 items-end pb-4 border-b last:border-0";
        div.innerHTML = `
            <div>
                <label class="text-xs font-body text-gray-600">Qty</label>
                <input type="number" class="item-qty w-full input-underline font-body" placeholder="1" value="1" min="0" step="any">
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Unit</label>
                <select class="item-unit w-full input-underline font-body bg-white">
                    <option value="Peti">Peti</option><option value="Bori">Bori</option><option value="Nag">Nag</option><option value="Dozen">Dozen</option><option value="Kg">Kg</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Description</label>
                <input type="text" class="item-desc w-full input-underline font-body" placeholder="Item name">
            </div>
            <div>
                <label class="text-xs font-body text-gray-600">Rate</label>
                <input type="number" class="item-rate w-full input-underline font-body" placeholder="0" value="0" min="0" step="any">
            </div>
            <div class="flex items-center gap-2">
                <button type="button" onclick="removeItem('${id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-md">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
        if (window.lucide) lucide.createIcons();
        const inputs = div.querySelectorAll("input, select");
        inputs.forEach(inp => inp.addEventListener("input", debounceUpdate));
        updateBill();
        div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function removeItem(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const all = document.querySelectorAll("#itemsList > div");
        if (all.length <= 1) {
            const qty = el.querySelector(".item-qty");
            const desc = el.querySelector(".item-desc");
            const rate = el.querySelector(".item-rate");
            const unit = el.querySelector(".item-unit");
            if (qty) qty.value = 0;
            if (desc) desc.value = "";
            if (rate) rate.value = 0;
            if (unit) unit.selectedIndex = 0;
        } else {
            el.remove();
        }
        updateBill();
    }

    let updateTimer = null;
    function debounceUpdate() {
        if (updateTimer) clearTimeout(updateTimer);
        updateTimer = setTimeout(() => { updateBill(); updateTimer = null; }, 120);
    }

    function printBill() {
        updateBill();
        setTimeout(() => window.print(), 150);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"'`=\/]/g, function (s) {
            return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[s];
        });
    }

    function updateBill() {
        const name = document.getElementById("customerName").value || "";
        const dateVal = document.getElementById("date").value || "";

        const rows = document.querySelectorAll("#itemsList > div");
        let subtotal = 0;
        let totalQty = 0;
        const previewRows = [];

        rows.forEach(row => {
            const qEl = row.querySelector(".item-qty");
            const rEl = row.querySelector(".item-rate");
            const uEl = row.querySelector(".item-unit");
            const dEl = row.querySelector(".item-desc");
            const qty = parseFloat(qEl?.value) || 0;
            const rate = parseFloat(rEl?.value) || 0;
            const unit = uEl?.value || "";
            const desc = dEl?.value || "";
            const lineTotal = qty * rate;
            subtotal += lineTotal;
            totalQty += qty;
            previewRows.push({ qty, unit, desc, rate, lineTotal });
        });

        const commissionPercent = parseFloat(document.getElementById("commissionPercent").value) || 0;
        const commission = (subtotal * (commissionPercent / 100));

        const freightPerItem = parseFloat(document.getElementById("freightPerItem").value) || 0;
        const laborPerItem = parseFloat(document.getElementById("laborPerItem").value) || 0;
        const munshiyanaFixed = parseFloat(document.getElementById("munshiyanaFixed").value) || 0;

        const freightTotal = freightPerItem * totalQty;
        const laborTotal = laborPerItem * totalQty;
        const munshiyanaTotal = munshiyanaFixed;

        const totalExpenses = commission + freightTotal + laborTotal + munshiyanaTotal;
        const netTotal = subtotal - totalExpenses;

        document.getElementById("previewName").textContent = name;
        if (dateVal) {
            const d = new Date(dateVal);
            document.getElementById("previewDate").textContent = d.toLocaleDateString("en-GB");
        } else {
            document.getElementById("previewDate").textContent = "";
        }

        document.getElementById("previewKachiBikri").textContent = subtotal > 0 ? formatCurrency(subtotal) : "-";
        document.getElementById("previewKharcha").textContent = totalExpenses > 0 ? formatCurrency(totalExpenses) : "-";
        document.getElementById("previewPakiBikri").textContent = (subtotal !== 0) ? formatCurrency(netTotal) : "-";

        document.getElementById("previewFreight").textContent = freightTotal > 0 ? formatCurrency(freightTotal) : "-";
        document.getElementById("previewCommission").textContent = commission > 0 ? formatCurrency(commission) : "-";
        document.getElementById("previewLabor").textContent = laborTotal > 0 ? formatCurrency(laborTotal) : "-";
        document.getElementById("previewMunshiyana").textContent = munshiyanaTotal > 0 ? formatCurrency(munshiyanaTotal) : "-";
        document.getElementById("previewTotalExp").textContent = totalExpenses > 0 ? formatCurrency(totalExpenses) : "-";

        const notes = document.getElementById("notes").value || "";
        const notesShort = document.getElementById("previewNotesShort");
        if (notes.trim()) {
            notesShort.textContent = notes;
        } else {
            notesShort.textContent = "(کوئی تفصیل نہیں)";
        }

        // Ensure preview direction/font matches current notes content
        applyDirectionForNotes(notes);

        const tbody = document.getElementById("itemsPreviewBody");
        if (tbody) {
            tbody.innerHTML = "";
            previewRows.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td class="py-2">${r.qty}</td><td class="py-2">${escapeHtml(r.unit)}</td><td class="py-2">${escapeHtml(r.desc)}</td><td class="py-2">${r.rate?formatCurrency(r.rate):"-"}</td><td class="py-2 font-bold">${r.lineTotal?formatCurrency(r.lineTotal):"-"}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    /* ---------- Image export & WhatsApp share (unchanged) ---------- */

    async function downloadImage() {
        updateBill();
        const el = document.getElementById('billPreview');
        const prevShadow = el.style.boxShadow;
        el.style.boxShadow = 'none';

        try {
            const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
            const dataUrl = canvas.toDataURL('image/png');

            el.style.boxShadow = prevShadow;

            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `bill-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (err) {
            console.error('Download image failed:', err);
            el.style.boxShadow = prevShadow;
            alert('تصویر بنانے میں مسئلہ آیا۔ براہِ کرم دوبارہ کوشش کریں۔');
        }
    }

    async function shareWhatsApp() {
        updateBill();
        const el = document.getElementById('billPreview');
        const prevShadow = el.style.boxShadow;
        el.style.boxShadow = 'none';

        try {
            const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1));
            el.style.boxShadow = prevShadow;

            const file = new File([blob], `bill-${Date.now()}.png`, { type: 'image/png' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'بل',
                        text: 'بل برائے حاجی عبدالعزیز اسماعیل'
                    });
                    return;
                } catch (err) {
                    console.warn('navigator.share failed:', err);
                }
            }

            const url = URL.createObjectURL(blob);
            const download = document.createElement('a');
            download.href = url;
            download.download = `bill-${Date.now()}.png`;
            document.body.appendChild(download);
            download.click();
            download.remove();

            setTimeout(() => { URL.revokeObjectURL(url); }, 30000);

            const msg = encodeURIComponent('میں نے بل ڈاؤنلوڈ کر لیا ہے — براہِ مہربانی اس تصویر کو واٹس ایپ میں منسلک کریں۔');
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        } catch (err) {
            console.error('Share error:', err);
            el.style.boxShadow = prevShadow;
            const msg = encodeURIComponent('Invoice generated. Please share manually.');
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        }
    }
</script>

</body>
</html>
